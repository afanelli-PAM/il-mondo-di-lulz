<%- include('partials/header') %>

    <!-- PDF.js & Page-Flip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>

    <div class="author-page">
        <!-- Hero Section -->
        <section class="hero-mini">
            <div class="container text-center">
                <h1 class="glow-text">Il libro</h1>
                <p class="subtitle">Scambia due parole con chi ha dato vita al Mondo di Lulz</p>
            </div>
        </section>

        <!-- Book Info Section -->
        <section class="section">
            <div class="container">
                <div class="book-details-grid">
                    <div class="book-visual">
                        <div class="floating-book" id="trigger-flipbook" style="cursor: pointer;"
                            title="Clicca per sfogliare il libro!">
                            <img src="/images/copertina.jpg" alt="Il Mondo di Lulz" class="img-fluid rounded shadow-lg">
                            <div class="open-hint">Clicca per leggere ðŸ“–</div>
                        </div>
                    </div>
                    <div class="book-text-content">
                        <h2 class="section-title">
                            <%= bookInfo.titolo %>
                        </h2>
                        <p class="author-name">di <strong>
                                <%= bookInfo.autore %>
                            </strong></p>
                        <div class="description-box">
                            <p>
                                <%= bookInfo.descrizione %>
                            </p>
                            <p>
                                <%= bookInfo.storia %>
                            </p>
                        </div>
                        <div class="themes-box">
                            <h3>Temi Principali</h3>
                            <ul>
                                <% bookInfo.temi.forEach(tema=> { %>
                                    <li><span class="star-bullet">âœ¦</span>
                                        <%= tema %>
                                    </li>
                                    <% }) %>
                            </ul>
                        </div>
                        <div class="author-download-actions"
                            style="display:flex; gap:1rem; flex-wrap:wrap; margin-top:2rem;">
                            <a href="/download/ebook" class="btn btn-primary btn-large btn-download" style="flex:1;">
                                &#x1F4D6; Scarica l'eBook (ePub)
                            </a>
                            <a href="/download/pdf" class="btn btn-secondary btn-large btn-download" style="flex:1;">
                                &#x1F4D6; Scarica il Libro (PDF)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interaction Section -->
        <section class="section bg-dark-soft">
            <div class="container">
                <div class="feedback-layout">
                    <div class="feedback-form-container">
                        <div class="card glass-card">
                            <h3>Lascia un segno</h3>
                            <p class="mb-4">Vuoi inviare un messaggio privato ad Antonio o lasciare una recensione
                                pubblica? <br>
                                <small class="text-muted italic">Nota: le recensioni saranno visibili dopo
                                    l'approvazione dell'autore.</small>
                            </p>

                            <% if (success) { %>
                                <div class="alert alert-success">
                                    Grazie! Il tuo feedback Ã¨ stato inviato con successo.
                                </div>
                                <% } %>

                                    <form action="/autore/feedback" method="POST" class="auth-form">
                                        <div class="form-group">
                                            <label for="nome">Nome</label>
                                            <input type="text" id="nome" name="nome" value="<%= formData.nome || '' %>"
                                                required placeholder="Il tuo nome">
                                        </div>
                                        <div class="form-group">
                                            <label for="email">Indirizzo Email</label>
                                            <input type="email" id="email" name="email" required
                                                placeholder="la-tua@email.com">
                                        </div>
                                        <div class="form-group">
                                            <label for="tipo">Tipo di Contatto</label>
                                            <select id="tipo" name="tipo" required onchange="toggleRating(this.value)">
                                                <option value="messaggio">Messaggio Privato all'Autore</option>
                                                <option value="recensione">Recensione Pubblica</option>
                                            </select>
                                        </div>
                                        <div class="form-group" id="rating-group" style="display: none;">
                                            <label>Valutazione</label>
                                            <div class="star-rating">
                                                <input type="radio" id="star5" name="valutazione" value="5"><label
                                                    for="star5">â˜…</label>
                                                <input type="radio" id="star4" name="valutazione" value="4"><label
                                                    for="star4">â˜…</label>
                                                <input type="radio" id="star3" name="valutazione" value="3"><label
                                                    for="star3">â˜…</label>
                                                <input type="radio" id="star2" name="valutazione" value="2"><label
                                                    for="star2">â˜…</label>
                                                <input type="radio" id="star1" name="valutazione" value="1"><label
                                                    for="star1">â˜…</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="contenuto">Il tuo messaggio</label>
                                            <textarea id="contenuto" name="contenuto" rows="5" required
                                                placeholder="Scrivi qui i tuoi pensieri sul libro..."></textarea>
                                        </div>

                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                        <button type="submit" class="btn btn-primary btn-block">Invia Feedback</button>
                                    </form>
                        </div>
                    </div>

                    <div class="reviews-display">
                        <h3 class="mb-4">Recensioni dei Lettori</h3>
                        <% if (recensioni.length===0) { %>
                            <p class="text-muted italic">Non ci sono ancora recensioni. Sii il primo a scriverne una!
                            </p>
                            <% } else { %>
                                <div class="reviews-list">
                                    <% recensioni.forEach(r=> { %>
                                        <div class="review-item">
                                            <div class="review-header">
                                                <span class="review-author">
                                                    <%= r.nome %>
                                                </span>
                                                <span class="review-stars">
                                                    <% for(let i=0; i<r.valutazione; i++) { %>â˜…<% } %>
                                                            <% for(let i=r.valutazione; i<5; i++) { %>â˜†<% } %>
                                                </span>
                                            </div>
                                            <p class="review-text">"<%= r.contenuto %>"</p>
                                            <span class="review-date">
                                                <%= new Date(r.created_at).toLocaleDateString('it-IT') %>
                                            </span>
                                        </div>
                                        <% }) %>
                                </div>
                                <% } %>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Flipbook Modal -->
    <div id="flipbook-overlay" class="flipbook-overlay">
        <div class="flipbook-container">
            <button id="close-flipbook" class="close-btn" title="Chiudi">&times;</button>
            <div id="book-container" class="book-container">
                <!-- Canvases will be injected here -->
            </div>
            <div class="flipbook-controls">
                <button id="prev-page" class="btn btn-secondary btn-sm">Indietro</button>
                <span id="page-info">Caricamento...</span>
                <button id="next-page" class="btn btn-secondary btn-sm">Avanti</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const pdfUrl = '/download/pdf';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pageFlip = null;
        const overlay = document.getElementById('flipbook-overlay');
        const trigger = document.getElementById('trigger-flipbook');
        const closeBtn = document.getElementById('close-flipbook');
        const bookContainer = document.getElementById('book-container');

        trigger.onclick = () => {
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            if (!pageFlip) loadPdf();
        };

        closeBtn.onclick = () => {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        };

        // Navigation button listeners (moved outside loadPdf for reliability)
        document.getElementById('prev-page').addEventListener('click', () => {
            if (pageFlip) pageFlip.flipPrev();
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (pageFlip) pageFlip.flipNext();
        });

        async function loadPdf() {
            try {
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;
                const totalPages = pdf.numPages;

                document.getElementById('page-info').innerText = `Caricamento... 1 / ${totalPages}`;

                // Create page elements
                for (let i = 1; i <= totalPages; i++) {
                    const pageNode = document.createElement('div');
                    pageNode.className = 'page-content';
                    const canvas = document.createElement('canvas');
                    pageNode.appendChild(canvas);
                    bookContainer.appendChild(pageNode);

                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                }

                // Initialize PageFlip
                pageFlip = new St.PageFlip(bookContainer, {
                    width: 550,
                    height: 733,
                    size: "stretch",
                    minWidth: 315,
                    maxWidth: 1000,
                    minHeight: 420,
                    maxHeight: 1350,
                    maxShadowOpacity: 0.5,
                    showCover: true,
                    mobileScrollSupport: false
                });

                pageFlip.loadFromHTML(document.querySelectorAll(".page-content"));

                pageFlip.on('flip', (e) => {
                    document.getElementById('page-info').innerText = `${e.data + 1} / ${totalPages}`;
                });

                document.getElementById('page-info').innerText = `1 / ${totalPages}`;
            } catch (err) {
                console.error("Flipbook error:", err);
                alert("Errore durante il caricamento del libro. Riprova piÃ¹ tardi.");
            }
        }

        function toggleRating(val) {
            const group = document.getElementById('rating-group');
            if (val === 'recensione') {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
                // Deseleziona le stelle se torniamo a messaggio
                const stars = group.querySelectorAll('input[type="radio"]');
                stars.forEach(s => s.checked = false);
            }
        }
    </script>

    <style>
        .author-page {
            color: #e0d5b0;
        }

        .hero-mini {
            padding: 80px 0;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 100%);
            border-bottom: 1px solid #daa52033;
        }

        .glow-text {
            color: #daa520;
            text-shadow: 0 0 15px rgba(218, 165, 32, 0.4);
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #888;
        }

        .section {
            padding: 60px 0;
        }

        .section-title {
            color: #daa520;
            margin-bottom: 1.5rem;
            font-size: 2.5rem;
        }

        .bg-dark-soft {
            background: rgba(255, 255, 255, 0.02);
        }

        .book-details-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 4rem;
            align-items: start;
        }

        .floating-book {
            animation: float 6s ease-in-out infinite;
            perspective: 1000px;
        }

        @keyframes float {
            0% {
                transform: translateY(0px) rotateY(-5deg);
            }

            50% {
                transform: translateY(-20px) rotateY(5deg);
            }

            100% {
                transform: translateY(0px) rotateY(-5deg);
            }
        }

        .description-box {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 2rem;
        }

        .themes-box h3 {
            color: #daa520;
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .themes-box ul {
            list-style: none;
            padding-left: 0;
        }

        .themes-box li {
            margin-bottom: 0.8rem;
        }

        .star-bullet {
            color: #daa520;
            margin-right: 10px;
        }

        .feedback-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
        }

        .glass-card {
            background: rgba(15, 15, 25, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid #daa52055;
            padding: 2.5rem;
            border-radius: 12px;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
            font-size: 1.5rem;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            cursor: pointer;
            color: #444;
            transition: color 0.2s;
        }

        .star-rating input:checked~label,
        .star-rating label:hover,
        .star-rating label:hover~label {
            color: #daa520;
        }

        /* Reviews */
        .review-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #daa520;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .review-author {
            font-weight: bold;
            color: #daa520;
        }

        .review-stars {
            color: #daa520;
            letter-spacing: 2px;
        }

        .review-text {
            font-style: italic;
            color: #bbb;
            line-height: 1.5;
        }

        .review-date {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            text-align: right;
        }

        @media (max-width: 991px) {

            .book-details-grid,
            .feedback-layout {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .book-visual {
                max-width: 300px;
                margin: 0 auto;
            }
        }

        /* Flipbook Modal */
        .flipbook-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .flipbook-overlay.active {
            display: flex;
        }

        .flipbook-container {
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .book-container {
            width: 100%;
            height: 80%;
            margin: auto;
        }

        .page-content {
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .page-content canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .close-btn {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
        }

        .flipbook-controls {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
            position: relative;
            z-index: 100;
        }

        .flipbook-controls button {
            position: relative;
            z-index: 101;
        }

        .open-hint {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(218, 165, 32, 0.8);
            color: #0a0a15;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .flipbook-container {
                width: 95vw;
                height: 80vh;
            }

            .flipbook-controls {
                font-size: 0.8rem;
            }
        }
    </style>

    <%- include('partials/footer') %>
