<%- include('../partials/header') %>

  <section class="dashboard-section">
    <div class="container">
      <div class="dashboard-header">
        <h1>Dashboard Amministrativa</h1>
        <p>Panoramica delle attività del Mondo di Lulz</p>
      </div>

      <!-- ═══ Statistiche principali ═══ -->
      <div class="dashboard-grid">
        <div class="dash-card">
          <div class="dash-card-icon">&#128101;</div>
          <h3>
            <%= stats.userCount %>
          </h3>
          <p>Utenti Registrati</p>
          <% if (stats.unverifiedCount> 0) { %>
            <small style="color:#ff9800;">
              <%= stats.unverifiedCount %> non verificati
            </small>
            <% } %>
              <div class="dash-card-actions">
                <a href="/admin/users" class="btn btn-secondary">Gestisci Utenti</a>
              </div>
        </div>

        <div class="dash-card">
          <div class="dash-card-icon">&#128302;</div>
          <h3>
            <%= stats.oracleCount %>
          </h3>
          <p>Richieste all'Oracolo</p>
        </div>

        <div class="dash-card">
          <div class="dash-card-icon">&#128065;</div>
          <h3>
            <%= stats.visitsTotal %>
          </h3>
          <p>Visite Totali</p>
          <small style="color:var(--text-muted);">
            Oggi: <strong>
              <%= stats.visitsToday %>
            </strong> &middot;
            7gg: <strong>
              <%= stats.visitsWeek %>
            </strong>
          </small>
        </div>

        <div class="dash-card">
          <div class="dash-card-icon">&#128100;</div>
          <h3>
            <%= stats.uniqueVisitorsTotal %>
          </h3>
          <p>Visitatori Unici</p>
          <small style="color:var(--text-muted);">
            Oggi: <strong>
              <%= stats.uniqueVisitorsToday %>
            </strong> &middot;
            7gg: <strong>
              <%= stats.uniqueVisitorsWeek %>
            </strong>
          </small>
        </div>

        <div class="dash-card">
          <div class="dash-card-icon">&#128214;</div>
          <h3>
            <%= stats.downloadsTotal %>
          </h3>
          <p>Download eBook (EPUB)</p>
          <small style="color:var(--text-muted);">
            Oggi: <strong>
              <%= stats.downloadsToday %>
            </strong> &middot;
            7gg: <strong>
              <%= stats.downloadsWeek %>
            </strong>
          </small>
        </div>

        <div class="dash-card">
          <div class="dash-card-icon">&#128196;</div>
          <h3>
            <%= stats.pdfTotal %>
          </h3>
          <p>Download eBook (PDF)</p>
          <small style="color:var(--text-muted);">
            Oggi: <strong>
              <%= stats.pdfToday %>
            </strong> &middot;
            7gg: <strong>
              <%= stats.pdfWeek %>
            </strong>
          </small>
        </div>

        <div class="dash-card">
          <div class="dash-card-icon">&#128737;&#65039;</div>
          <h3>Sessione</h3>
          <p>Amministratore Attivo</p>
          <div class="dash-card-actions">
            <a href="/admin/users" class="btn btn-secondary">Gestisci Utenti</a>
            <a href="/admin/feedback" class="btn btn-secondary" style="margin-top: 0.5rem; display: block;">Feedback
              Autore</a>
            <a href="/admin/settings" class="btn btn-secondary"
              style="margin-top: 0.5rem; display: block;">Impostazioni</a>
          </div>
        </div>
      </div>

      <!-- ═══ Grafico visite ultimi 7 giorni ═══ -->
      <div class="chart-card" style="margin-top:2rem;">
        <h2>Visite Ultimi 7 Giorni</h2>
        <div style="display:flex;align-items:flex-end;gap:0.6rem;min-height:180px;padding:1rem 0;">
          <% const maxVisite=Math.max(...visitsByDay.map(d=> d.visite), 1); %>
            <% for (let i=6; i>= 0; i--) {
              const dayDate = new Date(Date.now() - i * 86400000);
              const dayStr = dayDate.toISOString().split('T')[0];
              const match = visitsByDay.find(d => d.giorno === dayStr);
              const visite = match ? match.visite : 0;
              const unici = match ? match.unici : 0;
              const barH = Math.max((visite / maxVisite) * 140, 4);
              const dayLabel = dayDate.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' });
              %>
              <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:0.3rem;">
                <small style="color:var(--gold);font-weight:600;font-size:0.78rem;">
                  <%= visite %>
                </small>
                <div style="width:100%;max-width:50px;height:<%= barH %>px;
                                    background:linear-gradient(to top,#daa520,#b8860b);border-radius:4px 4px 0 0;"
                  title="<%= visite %> visite, <%= unici %> unici"></div>
                <small style="color:var(--text-muted);font-size:0.7rem;text-align:center;">
                  <%= dayLabel %>
                </small>
              </div>
              <% } %>
        </div>
      </div>

      <!-- ═══ Pagine più visitate + Ultimi registrati ═══ -->
      <div class="chart-grid" style="margin-top:1.5rem;">

        <div class="chart-card">
          <h2>Pagine Più Visitate</h2>
          <% if (topPages.length> 0) { %>
            <table class="planet-table">
              <thead>
                <tr>
                  <th>Pagina</th>
                  <th style="text-align:right;">Visite</th>
                </tr>
              </thead>
              <tbody>
                <% topPages.forEach(p=> { %>
                  <tr>
                    <td style="font-family:monospace;font-size:0.85rem;">
                      <%= p.page %>
                    </td>
                    <td style="text-align:right;font-weight:600;color:var(--gold);">
                      <%= p.visite %>
                    </td>
                  </tr>
                  <% }); %>
              </tbody>
            </table>
            <% } else { %>
              <p style="color:var(--text-muted);text-align:center;">Nessun dato ancora.</p>
              <% } %>
        </div>

        <div class="chart-card">
          <h2>Ultimi Registrati</h2>
          <table class="planet-table">
            <thead>
              <tr>
                <th>Utente</th>
                <th>Email</th>
                <th>Data</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% latestUsers.forEach(user=> { %>
                <tr>
                  <td>
                    <%= user.nome %>
                  </td>
                  <td>
                    <%= user.email %>
                  </td>
                  <td>
                    <%= new Date(user.created_at).toLocaleDateString('it-IT') %>
                  </td>
                  <td><a href="/admin/users/<%= user.id %>" class="btn btn-secondary"
                      style="padding:0.2rem 0.5rem;font-size:0.8rem;">Dettagli</a></td>
                </tr>
                <% }); %>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </section>

  <%- include('../partials/footer') %>